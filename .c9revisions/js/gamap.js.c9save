{"ts":1357169786088,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var Map=\r\n{\r\n\tmapDiv:\"currentMap\",\r\n\tmapSize:{x:336,y:240},\r\n\tmapPos:{},\r\n\tplayerPos:{},\r\n\titemPos:{},\r\n\tdebug:true,\r\n\tinit:function(data)\r\n\t{\r\n\t\tfor(k in data){\r\n\t\t\tvar itm=data[k];\r\n\t\t\tif(itm.name=='playerPos'){\r\n\t\t\t\tMap.movePlayer(itm.x,itm.y);\r\n\t\t\t\tdata.splice(k, 1);\r\n\t\t\t}\r\n\t\t}\r\n\t\tMap.addItems(data);\r\n\t\tif($('#'+this.mapDiv).length<1){\r\n\t\t\t$('body').prepend('<div id=\"'+this.mapDiv+'\" class=\"map\"></div>');\r\n\t\t}else{ //we collect current map info\r\n\t\t\tthis.mapSize.x=parseFloat($('#'+this.mapDiv).css('width').replace(/[^-\\d\\.]/g, ''));\r\n\t\t\tthis.mapSize.y=parseFloat($('#'+this.mapDiv).css('height').replace(/[^-\\d\\.]/g, ''));\r\n\t\t}\r\n\t\t//$('#'+this.mapDiv).css('background-image','url(\\'maps/'+map+'.png\\')');\r\n\r\n\t\tdocument.onkeydown = this.movePlayer;\r\n\t\t/*$(document).keypress(function(event) //didnt catch game keys \r\n\t\t{\r\n\t\t\tMap.movePlayer(event.which);\r\n\t\t});*/\r\n\t},\r\n\tmoveMap:function(x,y)\r\n\t{\r\n\t\tif(this.debug){console.log(\"Moving map (\"+x+\",\"+y+\")\");}\r\n\t\t/* Must we change player pos? */\r\n\t\tif(this.mapPos.x==x){\r\n\t\t\tvar playerY=0;\r\n\t\t\tif(this.mapPos.y<y){\r\n\t\t\t\tplayerY=this.mapSize.y-20;\r\n\t\t\t}\r\n\t\t\tthis.movePlayer(this.playerPos.x,playerY);\r\n\t\t}else if(this.mapPos.y==y){\r\n\t\t\tvar playerX=0;\r\n\t\t\tif(this.mapPos.x<x){\r\n\t\t\t\tplayerX=this.mapSize.x;\r\n\t\t\t}\r\n\t\t\tthis.movePlayer(playerX,this.playerPos.y);\r\n\t\t}\r\n\t\tthis.mapPos.x=x;\r\n\t\tthis.mapPos.y=y;\r\n\t\t$('#'+this.mapDiv).css('background-position',x+'px '+y+'px');\r\n\t\t\r\n\t},\r\n\tmovePlayer:function(key,y)\r\n\t{\r\n\t\tvar avatar='Down';\r\n\t\tif(typeof y =='undefined')\r\n\t\t{\r\n\t\t\t\r\n\t   \t\tvar tecla = (window.event) ? event.keyCode : key.keyCode,\r\n\t\t\t\tpixels=0,\r\n\t\t\t\tproperty='',\r\n\t\t\t\tnegative=false;\r\n\t\t\tswitch(tecla){\r\n\t\t\t\tcase 83: //avall\r\n\t\t\t\tcase 40:\r\n\t\t\t\t\tproperty='top';\r\n\t\t\t\t\tavatar='Down';\r\n\t\t\t\tbreak;\r\n\t\t\t\tcase 87: //adalt\r\n\t\t\t\tcase 38:\r\n\t\t\t\t\tproperty='top';\r\n\t\t\t\t\tnegative=true;\r\n\t\t\t\t\tavatar='Up';\r\n\t\t\t\tbreak;\r\n\t\t\t\tcase 68: //dreta\r\n\t\t\t\tcase 39:\r\n\t\t\t\t\tproperty='left';\r\n\t\t\t\t\tavatar='Right';\r\n\t\t\t\tbreak;\r\n\t\t\t\tcase 65://esquerra\r\n\t\t\t\tcase 37:\r\n\t\t\t\t\tproperty='left';\r\n\t\t\t\t\tnegative=true;\r\n\t\t\t\t\tavatar='Left';\r\n\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\treturn false;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tpixels=$('#myPlayer img').css(property).replace(/[^-\\d\\.]/g, '');\r\n\t\t\tif(pixels==\"auto\" || pixels==\"\"){\r\n\t\t\t\tpixels=0;\r\n\t\t\t}else{\r\n\t\t\t\tif(negative){\r\n\t\t\t\t\tpixels=parseFloat(pixels)-10;\r\n\t\t\t\t}else{\r\n\t\t\t\t\tpixels=parseFloat(pixels)+10;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// check if i can do following step\r\n\t\t\tvar i=0,lastI=0;\r\n\t\t\tif(property=='left'){\r\n\t\t\t\ti=Map.playerPos.x;\r\n\t\t\t}else{\r\n\t\t\t\ti=Map.playerPos.y;\r\n\t\t\t}\r\n\t\t\tlastI=i;\r\n\t\t\twhile(true)\r\n\t\t\t{\r\n\t\t\t\t$('#myPlayer img').css(property,i+'px');\r\n\t\t\t\tvar collisions=$(\"#myPlayer img\").collision('.mapSprite[type!=walk]');\r\n\t\t\t\tif(collisions.length>0)// collision detected, checking item type\r\n\t\t\t\t{\r\n\t\t\t\t\tvar itm=$(collisions[0]).attr('name');\r\n\t\t\t\t\t//console.log(items[itm]);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(items[itm].type=='solid'){\r\n\t\t\t\t\t\t//console.log(pixels,lastI,property,Map.playerPos.x,Map.playerPos.y);\r\n\t\t\t\t\t\t$('#myPlayer img').css(property,lastI+'px');\r\n\t\t\t\t\t\tif(property=='left'){\r\n\t\t\t\t\t\t\tMap.playerPos.x=lastI;\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tMap.playerPos.y=lastI;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconsole.log('cant');return false;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\tif(i==pixels){\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tlastI=i;\r\n\t\t\t\tif(i>pixels){\r\n\t\t\t\t\ti--;\r\n\t\t\t\t}else{\r\n\t\t\t\t\ti++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t//$('#myPlayer img').css(property,pixels+'px');\r\n\t\t\t\r\n\t\t\t/* Update playerPos*/\r\n\t\t\tif(property=='left'){\r\n\t\t\t\tMap.playerPos.x=pixels;\r\n\t\t\t}else{\r\n\t\t\t\tMap.playerPos.y=pixels;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//detect map change\r\n\t\t\tif(property=='top' && (pixels>=230 || pixels<=6))\r\n\t\t\t{\r\n\t\t\t\tvar y=Map.mapPos.y;\r\n\t\t\t\tif(pixels<=6){\r\n\t\t\t\t\ty+=Map.mapSize.y;\r\n\t\t\t\t}else{\r\n\t\t\t\t\ty-=Map.mapSize.y;\r\n\t\t\t\t}\r\n\t\t\t\tMap.moveMap(Map.mapPos.x,y);\r\n\t\t\t}else if(property=='left' && (pixels>=330 || pixels<=6)){\r\n\t\t\t\t\r\n\t\t\t\tvar x=Map.mapPos.x;\r\n\t\t\t\tif(pixels<=6){\r\n\t\t\t\t\tx+=Map.mapSize.x;\r\n\t\t\t\t}else{\r\n\t\t\t\t\tx-=Map.mapSize.x;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tMap.moveMap(x,Map.mapPos.y);\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\t$('#myPlayer img').css('top',y);\r\n\t\t\t$('#myPlayer img').css('left',key);\r\n\t\t\t\r\n\t\t\t/* Update playerPos*/\r\n\t\t\tthis.playerPos.y=y;\r\n\t\t\tthis.playerPos.x=key;\r\n\t\t}\r\n\t\t\r\n\t\t$('#myPlayer img').attr('src','avatars/0'+avatar+'.png');\r\n\t},\r\n\taddItem:function(obj)\r\n\t{\r\n\t\tif(typeof this.itemPos[obj.x] =='undefined'){\r\n\t\t\tthis.itemPos[obj.x]={};\r\n\t\t}\r\n\t\tthis.itemPos[obj.x][obj.y]=obj.name;\r\n\t\t$('#currentMap').append('<div class=\"mapSprite '+obj.name+'\" name=\"'+obj.name+'\" type=\"'+items[obj.name].type+'\" style=\"position:absolute;left:'+obj.x+'px;top:'+obj.y+'px;\"></div>');\r\n\t\tif(typeof Editor !='undefined'){\r\n\t\t\tif(Editor.initalized){\r\n\t\t\t\t$(\"#currentMap .mapSprite\" ).draggable({ containment: \"#currentMap\", obstacle: \".mapSprite\", preventCollision: true });\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\taddItems:function(arr){\r\n\t\tfor(k in arr){\r\n\t\t\tthis.addItem(arr[k]);\r\n\t\t}\r\n\t},\r\n\r\n}"]],"start1":0,"start2":0,"length1":0,"length2":4829}]],"length":4829}
